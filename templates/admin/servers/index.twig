{% extends 'admin/admin.twig' %}

{% import 'macros/admin.twig' as admin %}
{% import 'macros/paginator.twig' as paginator %}

{% block content %}
	<a href="{{ path_for('admin_servers_create') }}" class="uk-button uk-button-primary uk-width-1-3 uk-margin uk-margin-top">
		{{ trans('buttons', 'create') }}
	</a>
	<div class="uk-child-width-1-2@s" uk-grid>
        {% set hasPermissionsForView = has_access_permission('admin', 'server', 'view') %}
        {% for server in servers %}
			<div>
				<div class="uk-card uk-card-default">
					<div class="uk-card-header">
						<div class="uk-grid-small uk-flex-middle" uk-grid>
							<div class="uk-width-expand">
								<h3 class="uk-card-title uk-margin-remove-bottom">
									{% if hasPermissionsForView %}
										<a href="{{ path_for('admin_servers_view', {'server': server.id}) }}">{{ server.name }}</a>
									{% else %}
                                        {{ server.name }}
									{% endif %}
								</h3>
								<p class="uk-text-meta uk-margin-remove-top">{{ server.ip }}:{{ server.port }}</p>
							</div>
						</div>
					</div>
					<div class="uk-card-body">
                        {% embed "admin/actions.twig" with {'actionId': server.id} %}
                            {% block actions %}
								<li>
									<a href="{{ path_for('admin_servers_groups_list', {'server': server.id}) }}" class="dropdown-item">
										<i class="fas fa-users uk-margin-small-right"></i> &nbsp;{{ trans('admin_servers', 'groups') }}
									</a>
								</li>
								<li>
									<a href="{{ path_for('admin_servers_reasons_list', {'server': server.id}) }}" class="dropdown-item">
										<i class="fas fa-tasks uk-margin-small-right"></i> &nbsp;{{ trans('admin_servers', 'reasons') }}
									</a>
								</li>
								<li>
									<a href="#tokenModel" id="tokenModel" data-server-id="{{ server.id }}" uk-toggle>
										<i class="fas fa-barcode uk-margin-small-right"></i> &nbsp;{{ trans('admin_servers', 'token') }}
									</a>
								</li>
                            {% endblock %}
                        {% endembed %}

                        {{ admin.edit_btn(path_for('admin_servers_edit', {'server': server.id})) }}
                        {{ admin.delete_btn(path_for('admin_servers_delete', {'server': server.id})) }}
					</div>
				</div>
			</div>
        {% endfor %}
	</div>
	{{ paginator.render(pagination) }}
</div>
{% endblock %}

{% block javascript %}
    {{ parent() }}
	<script>
		$(document).ready(function () {
			UIkit.util.on('#tokenModel', 'click', function (e) {
			    e.preventDefault();
           		e.target.blur();
				var serverId = $(this).data('server-id');
				$.getJSON('{{ path_for('admin_servers_token') }}', {server: serverId})
					.done(function(data) {
                        if (data.success) {
                             UIkit.modal.dialog('<div class="uk-modal-header uk-light uk-background-secondary"><h2 class="uk-modal-title">{{ trans('admin_servers', 'token') }}</h2></div><p class="uk-modal-body">' + data.token + '</p>');
                        }
					})
                    .fail(function() {
                        console.log("error");
                    });
			});
        });
	</script>
{% endblock %}
